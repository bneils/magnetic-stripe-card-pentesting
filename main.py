#!/usr/bin/env python3
import sys
from encode import get_track2

def validate_pan(pan: str) -> bool:
    """Uses Luhn's algorithm to validate a PAN"""

    # every other digit starting from the second-to-last digit, working
    # backwards, is multiplied by two (and if it exceeds 9, subtracted by 9)
    # 0 -> 0  -> 0 (same as adding digits)
    # 1 -> 2  -> 2
    # 2 -> 4  -> 4
    # 3 -> 6  -> 6
    # 4 -> 8  -> 8
    # 5 -> 10 -> 1
    # 6 -> 12 -> 3
    # 7 -> 14 -> 5
    # 8 -> 16 -> 7
    # 9 -> 18 -> 9

    total = 0

    for i, c in enumerate(pan[::-1]):
        n = int(c)
        if i % 2 == 1:
            n *= 2
            if n > 9:
                n -= 9
        total += n

    return total % 10 == 0

if __name__ == "__main__":
    # errors are written to stderr in hopes (?) that it isn't piped to msrx
    if len(sys.argv) <= 1:
        sys.stderr.write("error: no arguments\n")
        exit(1)

    pan = sys.argv[1]
    if not validate_pan(pan):
        sys.stderr.write("error: PAN fails Luhn's algorithm\n")
        exit(1)
    print(get_track2(pan))

